<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PacketLab · V1.2  (Final Stable)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/lights/RectAreaLightUniformsLib.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&family=Roboto:wght@300;400;700&display=swap");
    @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&display=swap'); 

    :root {
        --bg-color: #050508;
        --text-main: #ffffff;
        --text-muted: #94a3b8;
        --panel-bg: rgba(4, 12, 24, 0.95);
        --panel-border: #00f0ff;
        --accent-primary: #00f0ff;
        --accent-secondary: #ff0055;
        --btn-bg-start: rgba(0, 240, 255, 0.1);
        --btn-bg-end: rgba(0, 240, 255, 0.3);
        --font-ui: "Orbitron", sans-serif;
        --font-data: "Share Tech Mono", monospace;
        --shadow-glow: 0 0 20px rgba(0, 240, 255, 0.2);
        --ui-scale: 1; 
    }

    body.theme-mirror {
        --bg-color: #f0f2f5;
        --text-main: #1a1a1a;
        --text-muted: #64748b;
        --panel-bg: rgba(255, 255, 255, 0.9);
        --panel-border: #e2e8f0;
        --accent-primary: #d9002b; 
        --accent-secondary: #f59e0b; 
        --btn-bg-start: rgba(217, 0, 43, 0.1);
        --btn-bg-end: rgba(217, 0, 43, 0.2);
        --font-ui: "Rajdhani", sans-serif;
        --font-data: "Roboto", sans-serif;
        --shadow-glow: 0 20px 40px rgba(0, 0, 0, 0.08);
        --ui-scale: 1.15; 
    }

    body.theme-matrix {
        --bg-color: #000000;
        --text-main: #00ff41;
        --text-muted: #008f11;
        --panel-bg: rgba(0, 20, 0, 0.92);
        --panel-border: #00ff41;
        --accent-primary: #00ff41;
        --accent-secondary: #ccffcc;
        --btn-bg-start: rgba(0, 255, 65, 0.1);
        --btn-bg-end: rgba(0, 255, 65, 0.2);
        --font-ui: "Courier New", monospace;
        --font-data: "Courier New", monospace;
        --shadow-glow: 0 0 15px rgba(0, 255, 65, 0.4);
        --ui-scale: 1.05;
    }

    body.lang-zh { font-family: "Noto Sans SC", sans-serif !important; --ui-scale: 1; }
    body.lang-zh .btn-action, body.lang-zh h1, body.lang-zh h2 { font-family: "Noto Sans SC", sans-serif !important; }

    body {
        margin: 0; overflow: hidden;
        background-color: var(--bg-color);
        font-family: var(--font-ui);
        color: var(--text-main);
        transition: background-color 0.5s, color 0.5s;
        font-size: calc(16px * var(--ui-scale));
    }

    #matrix-bg { position: absolute; inset: 0; z-index: 1; opacity: 0; pointer-events: none; background: transparent; transition: opacity 0.5s; }
    #canvas-container { position: absolute; inset: 0; z-index: 2; pointer-events: auto; }
    #ui-layer { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 16px; z-index: 20; overflow: hidden; }

    .panel {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-left: 4px solid var(--accent-primary);
        padding: 20px; pointer-events: auto;
        backdrop-filter: blur(12px);
        box-shadow: var(--shadow-glow);
        transition: all 0.3s ease;
        border-radius: 4px; box-sizing: border-box; 
    }
    body.theme-mirror .panel { border-radius: 0px; border: 1px solid #e2e8f0; border-left: 4px solid var(--accent-primary); }

    .header-container { height: 90px; min-height: 90px; display: flex; align-items: center; overflow: hidden; }
    h1 { font-size: 24px !important; font-weight: 900; letter-spacing: 1px; color: var(--accent-primary); margin: 0; line-height: 1.1; }
    #app-subtitle { font-size: 10px !important; line-height: 1.4; margin-top: 4px; }

    .btn-action {
        background: linear-gradient(90deg, var(--btn-bg-start), var(--btn-bg-end));
        border: 2px solid var(--accent-primary);
        color: var(--text-main); padding: 0 14px; width: 100%; height: 48px; 
        display: flex; align-items: center; justify-content: center;
        font-family: var(--font-ui); font-weight: 800; font-size: 1rem;
        text-transform: uppercase; letter-spacing: 1px;
        cursor: pointer; transition: all 0.2s; margin-top: 12px; position: relative; overflow: hidden; box-sizing: border-box;
    }
    body.theme-mirror .btn-action { background: var(--accent-primary); color: white; border: 2px solid transparent; border-radius: 0; box-shadow: 0 4px 6px rgba(255, 0, 51, 0.2); }
    body.theme-mirror .btn-action:hover { background: #b30024; transform: translateY(-1px); }
    .btn-action:hover { background: var(--accent-primary); color: var(--bg-color); border-color: var(--accent-primary); box-shadow: 0 0 20px var(--accent-primary); }
    .btn-action:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

    .btn-nav {
        background: rgba(0,0,0,0.05); border: 1px solid var(--panel-border);
        color: var(--text-main); font-size: 0.75rem; font-weight: 700; cursor: pointer; text-transform: uppercase; flex: 1;
        transition: all 0.2s; box-sizing: border-box; height: 36px; 
        display: flex; align-items: center; justify-content: center;
    }
    .btn-nav:hover { background: var(--accent-primary); color: var(--bg-color); border-color: var(--accent-primary); }

    .theme-controls { display: flex; height: 28px; align-items: center; }
    .btn-theme {
        font-size: 10px; width: 55px; height: 26px; border: 1px solid var(--panel-border);
        background: transparent; color: var(--text-muted); cursor: pointer;
        opacity: 0.8; transition: all 0.2s; margin-right: 4px; box-sizing: border-box;
        display: inline-flex; align-items: center; justify-content: center; text-transform: uppercase;
    }
    .btn-theme:hover, .btn-theme.active { opacity: 1; color: var(--bg-color); background: var(--accent-primary); border-color: var(--accent-primary); font-weight: bold; }
    .btn-lang {
        font-size: 10px; width: 24px; height: 24px; border: 1px solid var(--panel-border);
        background: transparent; color: var(--text-muted); cursor: pointer;
        opacity: 0.6; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; margin-left: 2px;
    }
    .btn-lang.active { opacity: 1; background: var(--accent-primary); color: var(--bg-color); font-weight: bold; }

    #layer-list { list-style: none; padding: 0; margin: 0; }
    .layer-item {
        padding: 0 10px; border-bottom: 1px solid var(--panel-border);
        font-size: 0.85rem; display: flex; justify-content: space-between;
        opacity: 0.5; transition: all 0.3s; font-family: var(--font-data); font-weight: 600; height: 38px; box-sizing: border-box; align-items: center;
    }
    .layer-item.active { opacity: 1; background: linear-gradient(90deg, rgba(128,128,128,0.1), transparent); font-weight: bold; border-left: 4px solid currentColor; padding-left: 16px; }
    .layer-item.completed { opacity: 1; }

    .info-block {
        background: rgba(128,128,128,0.08); border: 1px solid var(--panel-border);
        padding: 10px; margin-bottom: 10px; font-size: 0.85rem;
        color: var(--text-muted); font-family: var(--font-data);
        border-left: 3px solid var(--accent-secondary);
    }
    .info-label { font-size: 0.7rem; color: var(--accent-primary); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 4px; }

    #message-overlay {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 3rem; font-weight: 900; color: var(--accent-primary); text-shadow: 0 0 30px var(--accent-primary);
        pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 50;
        background: rgba(0,0,0,0.9); padding: 40px; border: 3px solid var(--accent-primary);
        width: 80%; text-align: center;
    }
    body.theme-mirror #message-overlay { background: transparent; border: none; font-family: 'Rajdhani', sans-serif; color: #ff0033; text-shadow: 3px 3px 0px #fff; }
    
    #compare-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 100; pointer-events: auto; padding: 20px; }
    #compare-box { max-width: 800px; width: 100%; background: var(--bg-color); border: 1px solid var(--accent-primary); padding: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.2); overflow-y: auto; max-height: 90vh; }
    table { width: 100%; border-collapse: collapse; color: var(--text-muted); font-size: 0.8rem; }
    th, td { border: 1px solid var(--panel-border); padding: 8px; text-align: left; }
    th { color: var(--accent-primary); background: rgba(128,128,128,0.05); }

    /* --- RESPONSIVE OPTIMIZATIONS --- */
    
    /* DESKTOP / TABLET */
    @media (min-width: 768px) {
        #ui-layer { padding: 20px; }
        .header-container { flex-direction: row; width: auto; }
        .controls-container { width: 380px; align-self: flex-end; margin-bottom: 20px; margin-right: 20px; }
        .desktop-nav { display: flex; } 
        #mobile-nav-bar { display: none; } /* Hide mobile bar on desktop */
        #left-stack { display: block; }
    }

    /* MOBILE (< 768px) */
    @media (max-width: 767px) {
        #ui-layer { padding: 0; } /* Full width */
        
        .header-container { 
            width: 100%; height: auto; min-height: auto; 
            padding: 10px; gap: 5px; flex-direction: column; align-items: flex-start;
            border-bottom: 1px solid var(--panel-border);
            background: var(--panel-bg);
            position: absolute; top: 0; left: 0; z-index: 30;
        }
        h1 { font-size: 18px !important; }
        #app-subtitle { display: none; }
        
        .controls-container {
            position: absolute;
            bottom: 70px; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 350px;
            margin: 0;
            padding: 15px;
            z-index: 30;
        }
        .desktop-nav { display: none; }

        /* Mobile Bottom Bar */
        #mobile-nav-bar {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: var(--panel-bg);
            border-top: 1px solid var(--panel-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            gap: 10px;
            pointer-events: auto;
            z-index: 40;
        }
        
        #left-stack { display: none !important; }
        .info-block { display: none; } 
    }
  </style>
</head>

<body class="theme-cyberpunk">

  <canvas id="matrix-bg"></canvas>
  <div id="canvas-container"></div>
  <div id="message-overlay">TRANSMITTED!</div>

  <!-- Modal Compare -->
  <div id="compare-overlay">
    <div id="compare-box">
      <div class="flex justify-between items-center mb-4">
        <h2 id="compare-title">COMPARISON OSI vs TCP/IP</h2>
        <button id="compare-close" class="btn-nav" style="flex:0; padding: 5px 15px;">X</button>
      </div>
      <div style="overflow-x:auto;">
        <table>
            <thead><tr><th>OSI</th><th id="compare-role">Role</th><th>TCP/IP</th></tr></thead>
            <tbody>
            <tr><td>7. Application</td><td>Web/Mail</td><td rowspan="3">Application</td></tr>
            <tr><td>6. Presentation</td><td>Format</td></tr>
            <tr><td>5. Session</td><td>Dialogue</td></tr>
            <tr><td>4. Transport</td><td id="compare-transport">Reliability</td><td>Transport</td></tr>
            <tr><td>3. Network</td><td id="compare-internet">Routing IP</td><td>Internet</td></tr>
            <tr><td>2. Data Link</td><td>MAC / Switch</td><td rowspan="2" id="compare-net-access">Network Access</td></tr>
            <tr><td>1. Physical</td><td>Cables</td></tr>
            </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="ui-layer">
    <!-- Top Bar -->
    <div class="panel header-container shadow-lg">
      <div class="w-full flex justify-between items-center md:block md:w-auto">
          <div>
              <h1 id="app-title">PacketLab <span style="font-size:0.6em; opacity:0.7;">V1.2 GEM</span></h1>
              <div id="app-subtitle" class="tracking-widest" style="color: var(--text-muted);">NETWORK FLOW VISUALIZER</div>
          </div>
          <div class="md:hidden">
              <span id="lbl-mode-mobile" class="text-[0.6rem] font-bold text-accent-secondary uppercase cursor-pointer">ENCAPSULATION</span>
          </div>
      </div>
      
      <div class="flex flex-col gap-1 md:gap-2 md:ml-auto w-full md:w-auto">
          <div class="flex justify-between items-center w-full">
             <div class="theme-controls">
                  <button class="btn-theme active" data-theme="cyberpunk">CYBER</button>
                  <button class="btn-theme" data-theme="mirror">MIRROR</button>
                  <button class="btn-theme" data-theme="matrix">MATRIX</button>
             </div>
             <div class="flex items-center ml-2 pl-2 border-l border-gray-600">
                 <button class="btn-lang active" id="lang-en" onclick="setLanguage('en')">EN</button>
                 <button class="btn-lang" id="lang-fr" onclick="setLanguage('fr')">FR</button>
                 <button class="btn-lang" id="lang-es" onclick="setLanguage('es')">ES</button>
                 <button class="btn-lang" id="lang-zh" onclick="setLanguage('zh')">ZH</button>
             </div>
          </div>
          
          <div class="hidden md:flex items-center mt-1">
              <span id="lbl-mode" class="text-[0.65rem] uppercase font-bold mr-2 opacity-70">MODE:</span>
              <button id="mode-toggle" class="text-xs font-bold uppercase hover:underline" style="color: var(--accent-secondary);">ENCAPSULATION</button>
          </div>
      </div>
    </div>

    <!-- Left Stack -->
    <div id="left-stack" class="panel absolute left-4 top-36 bottom-40 w-64 overflow-y-auto hidden shadow-lg">
        <div class="border-b pb-2 mb-2 flex justify-between items-center" style="border-color: var(--panel-border);">
            <h3 id="lbl-stack" class="text-xs font-bold tracking-widest" style="color: var(--accent-primary);">PROTOCOL STACK</h3>
        </div>
        <ul id="layer-list"></ul>
        <div class="mt-4 w-full h-2 rounded overflow-hidden" style="background: rgba(128,128,128,0.2);">
            <div id="progress-bar" class="h-full transition-all duration-500" style="width: 0%; background: var(--accent-primary);"></div>
        </div>
    </div>

    <!-- Right Controls -->
    <div class="panel controls-container shadow-2xl">
        <div class="border-b border-gray-700 pb-2 mb-2 flex justify-between items-end" style="border-color: var(--panel-border);">
            <h2 id="current-layer-title" style="margin:0;">LAYER 7: APPLICATION</h2>
            <span id="step-counter" class="text-xs font-mono opacity-70">1 / 7</span>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-2">
            <div>
                <span id="lbl-pdu" class="info-label">PDU (UNIT)</span>
                <div id="pdu-display" class="text-base font-bold" style="color: var(--text-main);">Data</div>
            </div>
            <div class="text-right">
                <span id="lbl-header" class="info-label">ADDED HEADER</span>
                <div id="header-display" class="text-md font-mono" style="color: var(--accent-primary);">Raw Data</div>
            </div>
        </div>

        <div class="mb-2">
            <span id="lbl-function" class="info-label">FUNCTION</span>
            <p id="desc-display" class="text-xs leading-snug" style="color: var(--text-muted);">User interface generation.</p>
        </div>

        <div class="info-block hidden md:block">
            <span id="lbl-details" class="info-label">DETAILS</span>
            <div id="header-details">HTTP, SMTP...</div>
        </div>
        
        <div class="info-block hidden md:block">
            <span id="lbl-example" class="info-label">EXAMPLE</span>
            <div id="examples-details">Opening a web page.</div>
        </div>

        <button id="action-btn" class="btn-action">ENCAPSULATE (LAYER 6)</button>

        <!-- Desktop Nav -->
        <div class="desktop-nav flex-col gap-2 mt-2">
            <div class="flex gap-2">
                <button id="prev-step-btn" class="btn-nav">◀</button>
                <button id="next-step-btn" class="btn-nav">▶</button>
                <button id="autoplay-btn" class="btn-nav" style="border-color: var(--accent-primary); flex: 2;">▶ AUTO</button>
            </div>

            <div class="flex gap-1 mt-2">
                <button id="speed-btn" class="btn-nav" style="font-size: 0.7rem;">1x</button>
                <button id="explode-btn" class="btn-nav" style="font-size: 0.6rem; flex:2;">EXPLODED</button>
                <button id="compare-btn" class="btn-nav" style="font-size: 0.6rem;">TCP/IP</button>
            </div>
            
            <button id="decap-btn" class="btn-action mt-2" style="display:none; background: var(--accent-secondary); border-color: var(--text-main); color: var(--text-main);">DECAPSULATION MODE</button>
            <button id="reset-btn" class="btn-action mt-2" style="display:none; background: #0f172a; color: #fff; border: 1px solid #333;">RESET</button>
        </div>
    </div>
    
    <!-- MOBILE BOTTOM NAV BAR -->
    <div id="mobile-nav-bar">
        <!-- Standard Controls -->
        <div id="mb-standard-controls" class="flex w-full gap-2 items-center justify-between">
            <button id="mb-prev" class="btn-nav" style="flex:0 0 50px;">◀</button>
            <div class="flex-1 flex justify-center gap-2">
                <button id="mb-auto" class="btn-nav text-[10px]">AUTO</button>
                <button id="mb-compare" class="btn-nav text-[10px]">TCP/IP</button>
            </div>
            <button id="mb-next" class="btn-nav" style="flex:0 0 50px;">▶</button>
        </div>
        
        <!-- Reset Button (Hidden by default) -->
        <button id="mb-reset" class="btn-action w-full hidden" style="margin:0; height: 100%; background: var(--accent-primary); color:white; border:none;">RESET</button>
    </div>
    
  </div>

  <script>
    // GLOBAL FUNCTIONS
    let setLanguage; 

    document.addEventListener('DOMContentLoaded', () => {
        
        // --- LOCALIZATION DATA ---
        const translations = {
            en: {
                title: "PacketLab <span style='font-size:0.6em; opacity:0.7;'>V1.2 GEM</span>",
                subtitle: "NETWORK FLOW VISUALIZER",
                lblMode: "MODE:",
                modeEncap: "ENCAPSULATION",
                modeDecap: "DECAPSULATION",
                lblPdu: "PDU (UNIT)",
                lblHeader: "ADDED HEADER",
                lblFunction: "FUNCTION",
                lblDetails: "TECHNICAL DETAILS",
                lblExample: "REAL WORLD EXAMPLE",
                lblStack: "PROTOCOL STACK",
                btnEncapStart: "ENCAPSULATE (LAYER 6)",
                btnTransmit: "TRANSMIT (PHYSICAL)",
                btnAdd: "ADD",
                btnRemove: "REMOVE",
                btnAccess: "ACCESS DATA",
                btnBack: "◀ BACK",
                btnNext: "NEXT ▶",
                btnAuto: "▶ AUTO",
                btnStop: "⏹ STOP",
                btnExplodeOn: "EXPLODED: ON",
                btnExplodeOff: "EXPLODED: OFF",
                btnReset: "RESET",
                btnDecapMode: "DECAPSULATION MODE",
                msgSending: "SENDING...",
                msgSent: "SENT!",
                msgReceived: "DATA RECEIVED!",
                compareTitle: "COMPARISON OSI vs TCP/IP",
                compareRole: "Role",
                compareTransport: "Reliability",
                compareInternet: "Internet",
                compareNetAccess: "Network Access",
                layer: "LAYER",
                stamp: "APPROVED"
            },
            fr: {
                title: "PacketLab <span style='font-size:0.6em; opacity:0.7;'>V1.2 GEM</span>",
                subtitle: "VISUALISATION DE FLUX RÉSEAU",
                lblMode: "MODE :",
                modeEncap: "ENCAPSULATION",
                modeDecap: "DÉCAPSULATION",
                lblPdu: "PDU (UNITÉ)",
                lblHeader: "EN-TÊTE AJOUTÉ",
                lblFunction: "FONCTION",
                lblDetails: "DÉTAILS TECHNIQUES",
                lblExample: "EXEMPLE RÉEL",
                lblStack: "PILE PROTOCOLAIRE",
                btnEncapStart: "ENCAPSULER (COUCHE 6)",
                btnTransmit: "TRANSMETTRE (PHYSIQUE)",
                btnAdd: "AJOUTER",
                btnRemove: "RETIRER",
                btnAccess: "ACCÉDER AUX DONNÉES",
                btnBack: "◀ RETOUR",
                btnNext: "SUIVANT ▶",
                btnAuto: "▶ AUTO",
                btnStop: "⏹ STOP",
                btnExplodeOn: "VUE ÉCLATÉE : ON",
                btnExplodeOff: "VUE ÉCLATÉE : OFF",
                btnReset: "RÉINITIALISER",
                btnDecapMode: "MODE DÉCAPSULATION",
                msgSending: "ENVOI EN COURS...",
                msgSent: "ENVOYÉ !",
                msgReceived: "DONNÉES REÇUES !",
                compareTitle: "COMPARATIF OSI vs TCP/IP",
                compareRole: "Rôle",
                compareTransport: "Fiabilité",
                compareInternet: "Internet",
                compareNetAccess: "Accès Réseau",
                layer: "COUCHE",
                stamp: "VALIDÉ"
            },
            es: {
                title: "PacketLab <span style='font-size:0.6em; opacity:0.7;'>V1.2 GEM</span>",
                subtitle: "VISUALIZADOR DE FLUJO DE RED",
                lblMode: "MODO:",
                modeEncap: "ENCAPSULACIÓN",
                modeDecap: "DESENCAPSULACIÓN",
                lblPdu: "PDU (UNIDAD)",
                lblHeader: "ENCABEZADO AÑADIDO",
                lblFunction: "FUNCIÓN",
                lblDetails: "DETALLES TÉCNICOS",
                lblExample: "EJEMPLO REAL",
                lblStack: "PILA DE PROTOCOLOS",
                btnEncapStart: "ENCAPSULAR (CAPA 6)",
                btnTransmit: "TRANSMITIR (FÍSICA)",
                btnAdd: "AÑADIR",
                btnRemove: "QUITAR",
                btnAccess: "ACCEDER A DATOS",
                btnBack: "◀ ATRÁS",
                btnNext: "SIGUIENTE ▶",
                btnAuto: "▶ AUTO",
                btnStop: "⏹ STOP",
                btnExplodeOn: "VISTA EXPLOTADA: ON",
                btnExplodeOff: "VISTA EXPLOTADA: OFF",
                btnReset: "REINICIAR",
                btnDecapMode: "MODO DESENCAPSULACIÓN",
                msgSending: "ENVIANDO...",
                msgSent: "¡ENVIADO!",
                msgReceived: "¡DATOS RECIBIDOS!",
                compareTitle: "COMPARACIÓN OSI vs TCP/IP",
                compareRole: "Rol",
                compareTransport: "Fiabilidad",
                compareInternet: "Internet",
                compareNetAccess: "Acceso a Red",
                layer: "CAPA",
                stamp: "APROBADO"
            },
            zh: {
                title: "PacketLab <span style='font-size:0.6em; opacity:0.7;'>V1.2 GEM</span>",
                subtitle: "网络流量可视化工具",
                lblMode: "模式:",
                modeEncap: "封装",
                modeDecap: "解封装",
                lblPdu: "PDU (单元)",
                lblHeader: "添加的头部",
                lblFunction: "功能",
                lblDetails: "技术细节",
                lblExample: "真实示例",
                lblStack: "协议栈",
                btnEncapStart: "封装 (第6层)",
                btnTransmit: "传输 (物理层)",
                btnAdd: "添加",
                btnRemove: "移除",
                btnAccess: "访问数据",
                btnBack: "◀ 返回",
                btnNext: "下一步 ▶",
                btnAuto: "▶ 自动",
                btnStop: "⏹ 停止",
                btnExplodeOn: "爆炸视图: 开",
                btnExplodeOff: "爆炸视图: 关",
                btnReset: "重置",
                btnDecapMode: "解封装模式",
                msgSending: "发送中...",
                msgSent: "已发送!",
                msgReceived: "数据已接收!",
                compareTitle: "OSI 与 TCP/IP 比较",
                compareRole: "角色",
                compareTransport: "可靠性",
                compareInternet: "互联网",
                compareNetAccess: "网络接入",
                layer: "层",
                stamp: "批准"
            }
        };

        const osiData = {
            en: [
              { id: 7, name: "Application",  pdu: "Data",    color: "#e6002e", header: "Raw Data", desc: "User interface. Data generation.", details: ["HTTP, SMTP, DNS", "User Payload"], ex: "Sending an email." },
              { id: 6, name: "Presentation", pdu: "Data",    color: "#ff6600", header: "Format",   desc: "Translation, Encryption and Compression.", details: ["SSL/TLS, JPEG, ASCII", "Binary Encoding"], ex: "HTTPS Encryption." },
              { id: 5, name: "Session",      pdu: "Data",    color: "#ffaa00", header: "Session ID", desc: "Dialogue management between apps.", details: ["Sync Tokens, RPC"], ex: "Login session." },
              { id: 4, name: "Transport",    pdu: "Segment", color: "#0099ff", header: "TCP/UDP Ports", desc: "Segmentation and reliability.", details: ["Src/Dst Port, Seq Num"], ex: "Reliable packet transport." },
              { id: 3, name: "Network",      pdu: "Packet",  color: "#00cc66", header: "IP Src/Dst", desc: "Logical routing (Internet).", details: ["IP v4/v6, TTL"], ex: "IP Routing." },
              { id: 2, name: "Data Link",    pdu: "Frame",   color: "#8800ff", header: "MAC + FCS",  desc: "Physical addressing (Switch).", details: ["MAC Addr, CRC"], ex: "Ethernet / Wifi." },
              { id: 1, name: "Physical",     pdu: "Bits",    color: "#c0c0c0", header: "Signal",     desc: "Binary transmission over medium.", details: ["Voltage, Radio Waves"], ex: "RJ45 Cable." }
            ],
            fr: [
              { id: 7, name: "Application",  pdu: "Données", color: "#e6002e", header: "Données Brutes", desc: "Interface utilisateur. Génération.", details: ["HTTP, SMTP, DNS", "Payload Utilisateur"], ex: "Envoi d'un email." },
              { id: 6, name: "Présentation", pdu: "Données", color: "#ff6600", header: "Formatage",   desc: "Traduction, Chiffrement et Compression.", details: ["SSL/TLS, JPEG, ASCII", "Encodage binaire"], ex: "Chiffrement HTTPS." },
              { id: 5, name: "Session",      pdu: "Données", color: "#ffaa00", header: "ID Session", desc: "Gestion du dialogue entre applis.", details: ["Sync Tokens, RPC"], ex: "Session de login." },
              { id: 4, name: "Transport",    pdu: "Segment", color: "#0099ff", header: "Ports TCP/UDP", desc: "Segmentation et fiabilité.", details: ["Port Src/Dst, Seq Num"], ex: "Transport fiable." },
              { id: 3, name: "Réseau",       pdu: "Paquet",  color: "#00cc66", header: "IP Src/Dst", desc: "Routage logique (Internet).", details: ["IP v4/v6, TTL"], ex: "Routage IP." },
              { id: 2, name: "Liaison",      pdu: "Trame",   color: "#8800ff", header: "MAC + FCS",  desc: "Adressage physique (Switch).", details: ["MAC Addr, CRC"], ex: "Ethernet / Wifi." },
              { id: 1, name: "Physique",     pdu: "Bits",    color: "#c0c0c0", header: "Signal",     desc: "Transmission binaire sur média.", details: ["Voltage, Ondes Radio"], ex: "Câble RJ45." }
            ],
            es: [
              { id: 7, name: "Aplicación",   pdu: "Datos",   color: "#e6002e", header: "Datos Brutos", desc: "Interfaz de usuario. Generación de datos.", details: ["HTTP, SMTP, DNS", "Carga Útil"], ex: "Enviar un correo." },
              { id: 6, name: "Presentación", pdu: "Datos",   color: "#ff6600", header: "Formato",    desc: "Traducción, Cifrado y Compresión.", details: ["SSL/TLS, JPEG, ASCII", "Codificación Binaria"], ex: "Cifrado HTTPS." },
              { id: 5, name: "Sesión",       pdu: "Datos",   color: "#ffaa00", header: "ID Sesión",  desc: "Gestión del diálogo entre aplicaciones.", details: ["Tokens Sinc, RPC"], ex: "Sesión de login." },
              { id: 4, name: "Transporte",   pdu: "Segmento",color: "#0099ff", header: "Puertos TCP",desc: "Segmentación y fiabilidad.", details: ["Puerto Org/Dst, Secuencia"], ex: "Transporte fiable." },
              { id: 3, name: "Red",          pdu: "Paquete", color: "#00cc66", header: "IP Org/Dst", desc: "Enrutamiento lógico (Internet).", details: ["IP v4/v6, TTL"], ex: "Enrutamiento IP." },
              { id: 2, name: "Enlace Datos", pdu: "Trama",   color: "#8800ff", header: "MAC + FCS",  desc: "Direccionamiento físico (Switch).", details: ["Dir MAC, CRC"], ex: "Ethernet / Wifi." },
              { id: 1, name: "Física",       pdu: "Bits",    color: "#c0c0c0", header: "Señal",      desc: "Transmisión binaria por medio.", details: ["Voltaje, Ondas Radio"], ex: "Cable RJ45." }
            ],
            zh: [
              { id: 7, name: "应用层",       pdu: "数据",    color: "#e6002e", header: "原始数据",   desc: "用户界面。数据生成。", details: ["HTTP, SMTP, DNS", "用户负载"], ex: "发送电子邮件。" },
              { id: 6, name: "表示层",       pdu: "数据",    color: "#ff6600", header: "格式",       desc: "翻译、加密和压缩。", details: ["SSL/TLS, JPEG, ASCII", "二进制编码"], ex: "HTTPS 加密。" },
              { id: 5, name: "会话层",       pdu: "数据",    color: "#ffaa00", header: "会话 ID",    desc: "应用程序之间的对话管理。", details: ["同步令牌, RPC"], ex: "登录会话。" },
              { id: 4, name: "传输层",       pdu: "段",      color: "#0099ff", header: "TCP/UDP端口",desc: "分段和可靠性。", details: ["源/目的端口, 序列号"], ex: "可靠的数据包传输。" },
              { id: 3, name: "网络层",       pdu: "包",      color: "#00cc66", header: "IP 源/目的", desc: "逻辑路由 (互联网)。", details: ["IP v4/v6, TTL"], ex: "IP 路由。" },
              { id: 2, name: "数据链路层",   pdu: "帧",      color: "#8800ff", header: "MAC + FCS",  desc: "物理寻址 (交换机)。", details: ["MAC 地址, CRC"], ex: "以太网 / Wifi。" },
              { id: 1, name: "物理层",       pdu: "比特",    color: "#c0c0c0", header: "信号",       desc: "介质上的二进制传输。", details: ["电压, 无线电波"], ex: "RJ45 线缆。" }
            ]
        };

        // --- GLOBAL VARIABLES ---
        let currentLang = 'en';
        let currentStep = 0;
        let mode = 'encap';
        let theme = 'cyberpunk';
        let isAnimating = false;
        let isExploded = false;
        let autoplayTimer = null;
        let speedMult = 1;

        // 3D Variables
        let scene, camera, renderer, composer, controls;
        let packetGroup, particles, layerBoxes = [];
        let floorPlane, floorGrid;
        let lights = {};
        let stampMesh = null; 
        
        let matrixTexture = null;

        // UI Refs
        const ui = {
            title: document.getElementById('app-title'),
            subtitle: document.getElementById('app-subtitle'),
            lblMode: document.getElementById('lbl-mode'),
            modeLabel: document.getElementById('mode-toggle'),
            
            // Labels
            lblPdu: document.getElementById('lbl-pdu'),
            lblHeader: document.getElementById('lbl-header'),
            lblFunction: document.getElementById('lbl-function'),
            lblDetails: document.getElementById('lbl-details'),
            lblExample: document.getElementById('lbl-example'),
            lblStack: document.getElementById('lbl-stack'),
            
            // Dynamic Content
            layerTitle: document.getElementById('current-layer-title'),
            pdu: document.getElementById('pdu-display'),
            header: document.getElementById('header-display'),
            desc: document.getElementById('desc-display'),
            details: document.getElementById('header-details'),
            ex: document.getElementById('examples-details'),
            list: document.getElementById('layer-list'),
            bar: document.getElementById('progress-bar'),
            step: document.getElementById('step-counter'),
            
            // Buttons
            btnMain: document.getElementById('action-btn'),
            btnDecap: document.getElementById('decap-btn'),
            btnReset: document.getElementById('reset-btn'),
            btnBack: document.getElementById('prev-step-btn'),
            btnNext: document.getElementById('next-step-btn'),
            btnAuto: document.getElementById('autoplay-btn'),
            btnExplode: document.getElementById('explode-btn'),
            
            // Mobile Buttons
            mbPrev: document.getElementById('mb-prev'),
            mbNext: document.getElementById('mb-next'),
            mbAuto: document.getElementById('mb-auto'),
            mbCompare: document.getElementById('mb-compare'),
            mbReset: document.getElementById('mb-reset'),
            
            msg: document.getElementById('message-overlay')
        };

        // --- CAMERA AND LAYOUT ADJUSTMENT LOGIC ---
        function adjustLayout() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            // Detect layout mode
            const isMobile = width < 768;
            const isTablet = width >= 768 && width < 1024;
            
            if (isMobile) {
                // Mobile: UI at top and bottom.
                // To center the cube in the "clear" space between header and bottom panel:
                // We shift the camera target DOWN (negative Y).
                // This effectively moves the world (and the cube at Y=0) UP on the screen.
                controls.target.set(0, -2.5, 0);
                camera.position.z = 15; 
            } else if (isTablet) {
                // Tablet: Slight upward shift
                controls.target.set(0, -1, 0);
                camera.position.z = 12;
            } else {
                // Desktop: UI on sides. Center is (0,0,0)
                controls.target.set(0, 0, 0);
                camera.position.z = 10;
            }
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
            composer.setSize(width, height);
            
            // Matrix background resize
            const matCanvas = document.getElementById('matrix-bg');
            if(matCanvas) {
                matCanvas.width = width;
                matCanvas.height = height;
            }
        }

        // --- LANGUAGE HANDLING ---
        setLanguage = function(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            document.querySelectorAll('.btn-lang').forEach(b => b.classList.remove('active'));
            document.getElementById('lang-' + lang).classList.add('active');
            
            if(lang === 'zh') document.body.classList.add('lang-zh');
            else document.body.classList.remove('lang-zh');

            ui.title.innerHTML = t.title;
            ui.subtitle.innerText = t.subtitle;
            
            const modeText = mode === 'encap' ? t.modeEncap : t.modeDecap;
            if(ui.lblMode) ui.lblMode.innerText = t.lblMode;
            if(ui.lblModeMobile) {
               const mobileMode = document.getElementById('lbl-mode-mobile');
               if(mobileMode) mobileMode.innerText = modeText;
            }
            ui.modeLabel.innerText = modeText;

            document.getElementById('lbl-pdu').innerText = t.lblPdu;
            document.getElementById('lbl-header').innerText = t.lblHeader;
            document.getElementById('lbl-function').innerText = t.lblFunction;
            
            if(document.getElementById('lbl-details')) document.getElementById('lbl-details').innerText = t.lblDetails;
            if(document.getElementById('lbl-example')) document.getElementById('lbl-example').innerText = t.lblExample;
            if(document.getElementById('lbl-stack')) document.getElementById('lbl-stack').innerText = t.lblStack;
            
            const autoText = !autoplayTimer ? t.btnAuto : t.btnStop;
            ui.btnAuto.innerText = autoText;
            if (ui.mbAuto) ui.mbAuto.innerText = autoText;
            if (ui.mbReset) ui.mbReset.innerText = t.btnReset;
            
            ui.btnExplode.innerText = isExploded ? t.btnExplodeOn : t.btnExplodeOff;
            ui.btnReset.innerText = t.btnReset;
            ui.btnDecap.innerText = t.btnDecapMode;
            
            document.getElementById('compare-title').innerText = t.compareTitle;
            document.getElementById('compare-role').innerText = t.compareRole;
            document.getElementById('compare-transport').innerText = t.compareTransport;
            document.getElementById('compare-internet').innerText = t.compareInternet;
            document.getElementById('compare-net-access').innerText = t.compareNetAccess;

            updateUI();
        };

        // --- INITIALIZATION ---
        function init() {
            initMatrixRain();

            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            
            // Adjust camera based on screen size
            const isMobile = window.innerWidth < 768;
            const camZ = isMobile ? 14 : 10; // Move back on mobile
            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
            // Position will be set by adjustLayout
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.physicallyCorrectLights = true; 
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.setClearColor(0x000000, 0); 
            
            container.appendChild(renderer.domElement);

            const renderPass = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.15;
            bloomPass.strength = 0.4;
            bloomPass.radius = 0.4;
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderPass);
            composer.addPass(bloomPass);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.8;

            packetGroup = new THREE.Group();
            scene.add(packetGroup);

            const planeGeo = new THREE.PlaneGeometry(200, 200);
            const planeMat = new THREE.MeshStandardMaterial({ 
                color: 0xffffff, roughness: 0.8, metalness: 0.0
            });
            floorPlane = new THREE.Mesh(planeGeo, planeMat);
            floorPlane.rotation.x = -Math.PI / 2;
            floorPlane.position.y = -4;
            floorPlane.receiveShadow = true;
            floorPlane.visible = false; 
            scene.add(floorPlane);

            floorGrid = new THREE.GridHelper(60, 60, 0x444444, 0x222222);
            floorGrid.position.y = -3.99;
            floorGrid.material.transparent = true;
            floorGrid.material.opacity = 0.15;
            scene.add(floorGrid);

            createParticles();
            setTheme('cyberpunk');
            resetGame('encap');
            setLanguage('en'); 
            adjustLayout();
            animate();
            
            window.addEventListener('resize', adjustLayout);
            
            // Event Listeners
            document.getElementById('mode-toggle').onclick = () => resetGame(mode === 'encap' ? 'decap' : 'encap');
            
            const mobileModeLbl = document.getElementById('lbl-mode-mobile');
            if(mobileModeLbl) {
                mobileModeLbl.onclick = () => resetGame(mode === 'encap' ? 'decap' : 'encap');
            }
            
            const doNext = () => nextStep();
            const doPrev = () => prevStep();
            const doAuto = () => toggleAutoplay();
            const doReset = () => resetGame(mode);

            if(ui.btnMain) ui.btnMain.onclick = doNext;
            if(ui.btnReset) ui.btnReset.onclick = doReset;
            if(ui.btnDecap) ui.btnDecap.onclick = () => resetGame('decap');

            ui.btnBack.onclick = doPrev;
            ui.btnNext.onclick = doNext;
            ui.btnAuto.onclick = doAuto;
            
            if (ui.mbPrev) ui.mbPrev.onclick = doPrev;
            if (ui.mbNext) ui.mbNext.onclick = doNext;
            if (ui.mbAuto) ui.mbAuto.onclick = doAuto;
            if (ui.mbCompare) ui.mbCompare.onclick = () => document.getElementById('compare-overlay').style.display = 'flex';
            if (ui.mbReset) ui.mbReset.onclick = doReset;

            document.getElementById('speed-btn').onclick = toggleSpeed;
            document.getElementById('explode-btn').onclick = toggleExplode;
            
            document.getElementById('compare-btn').onclick = () => document.getElementById('compare-overlay').style.display = 'flex';
            document.getElementById('compare-close').onclick = () => document.getElementById('compare-overlay').style.display = 'none';
            
            document.querySelectorAll('.btn-theme').forEach(btn => {
                btn.onclick = () => setTheme(btn.dataset.theme);
            });
        }
        
        function updateLights() {
            Object.values(lights).forEach(l => scene.remove(l));
            lights = {};

            if(theme === 'mirror') {
                const ambient = new THREE.AmbientLight(0xffffff, 1.5);
                lights.ambient = ambient;
                const dirLight = new THREE.DirectionalLight(0xffffff, 3);
                dirLight.position.set(5, 15, 8);
                dirLight.castShadow = true;
                dirLight.shadow.mapSize.width = 1024;
                dirLight.shadow.mapSize.height = 1024;
                lights.main = dirLight;
                const backLight = new THREE.DirectionalLight(0xddeeff, 2);
                backLight.position.set(-5, 5, -10);
                lights.back = backLight;
            } else {
                const ambient = new THREE.AmbientLight(0xffffff, 1.0);
                lights.ambient = ambient;
                const dirLight = new THREE.DirectionalLight(0xffffff, 4.0);
                dirLight.position.set(5, 10, 7);
                dirLight.castShadow = true;
                lights.main = dirLight;
                const pointLight = new THREE.PointLight(theme === 'matrix' ? 0x00ff00 : 0x00f3ff, 5, 20);
                pointLight.position.set(-5, 2, 5);
                lights.point = pointLight;
            }
            Object.values(lights).forEach(l => scene.add(l));
        }

        function setTheme(newTheme) {
            theme = newTheme;
            document.body.className = `theme-${theme}`;
            document.querySelectorAll('.btn-theme').forEach(b => {
                b.classList.toggle('active', b.dataset.theme === theme);
            });

            const matBg = document.getElementById('matrix-bg');
            const bgCol = getComputedStyle(document.body).getPropertyValue('--bg-color').trim();
            
            if(theme === 'matrix') {
                if(matBg) matBg.style.opacity = 1;
                scene.background = null; 
                scene.fog = null; 
            } else if(theme === 'mirror') {
                if(matBg) matBg.style.opacity = 0;
                scene.background = new THREE.Color(bgCol);
                scene.fog = new THREE.Fog(bgCol, 15, 40);
            } else {
                if(matBg) matBg.style.opacity = 0;
                scene.background = new THREE.Color(bgCol);
                scene.fog = new THREE.FogExp2(new THREE.Color(bgCol), 0.02);
            }

            if(theme === 'mirror') {
                floorPlane.visible = true;
                floorGrid.visible = true;
                floorGrid.material.color.setHex(0xd1d5db);
                floorGrid.material.opacity = 0.5;
                composer.passes[1].strength = 0; 
            } else {
                floorPlane.visible = false;
                floorGrid.visible = true;
                floorGrid.material.color.setHex(theme === 'matrix' ? 0x00ff00 : 0x444444);
                floorGrid.material.opacity = 0.15;
                composer.passes[1].strength = 0.4;
            }

            updateLights();
            rebuildSceneMaterials();
            updateUI(); 
        }

        function rebuildSceneMaterials() {
            const layers = osiData[currentLang] || osiData['en'];
            layerBoxes.forEach((mesh) => {
                const layerId = mesh.userData.id;
                const layerData = layers.find(l => l.id === layerId);
                
                if(layerId === 7) {
                    if(theme === 'mirror') {
                        mesh.material = new THREE.MeshPhysicalMaterial({ 
                            color: 0xd9002b, emissive: 0x550000, roughness: 0.1, metalness: 0.1,
                            clearcoat: 1.0, clearcoatRoughness: 0.1
                        });
                        if(mesh.children[0]) mesh.children[0].visible = false;
                    } else if (theme === 'matrix') {
                        mesh.material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                        if(mesh.children[0]) { mesh.children[0].visible = true; mesh.children[0].material.color.setHex(0x00ff00); }
                    } else {
                        // Cyberpunk: Now Red/Ruby too (but glowing)
                         mesh.material = new THREE.MeshPhysicalMaterial({ 
                            color: 0xe6002e, 
                            emissive: 0xe6002e, 
                            emissiveIntensity: 0.5, 
                            roughness: 0.2, 
                            metalness: 0.8,
                            transmission: 0.1
                        });
                        if(mesh.children[0]) { mesh.children[0].visible = true; mesh.children[0].material.color.setHex(0xffaaaa); }
                    }
                } else if (layerData) {
                    let displayColor = layerData.color;
                    if(theme === 'mirror' && layerId === 1) displayColor = "#1a1a1a"; 
                    mesh.material = getThemeMaterial(displayColor);
                    
                    const edge = mesh.children.find(c => c.type === 'LineSegments' || c.type === 'Line');
                    if(edge) {
                        if(theme === 'mirror') {
                            edge.visible = true;
                            edge.material.color.setHex(parseInt(displayColor.replace('#','0x')));
                            edge.material.opacity = 0.8;
                            edge.material.linewidth = 2;
                        } else if (theme === 'matrix') {
                            edge.visible = true;
                            edge.material.color.setHex(0x00ff00);
                            edge.material.opacity = 0.3;
                        } else {
                            edge.visible = true;
                            edge.material.color.setHex(parseInt(layerData.color.replace('#','0x')));
                            edge.material.opacity = 0.8;
                        }
                    }
                }
            });
        }

        function getThemeMaterial(colorHex) {
            if (theme === 'mirror') {
                return new THREE.MeshPhysicalMaterial({
                    color: colorHex, transmission: 0.5, opacity: 1, metalness: 0, roughness: 0.1,
                    ior: 1.5, thickness: 0.5, side: THREE.DoubleSide, transparent: true
                });
            } else if (theme === 'matrix') {
                return new THREE.MeshBasicMaterial({
                    color: 0x003300, wireframe: true, transparent: true, opacity: 0.2, side: THREE.DoubleSide
                });
            } else {
                return new THREE.MeshPhysicalMaterial({
                    color: colorHex, transmission: 0.6, opacity: 0.4, metalness: 0.5, roughness: 0.2,
                    ior: 1.2, transparent: true, side: THREE.DoubleSide,
                    emissive: colorHex, emissiveIntensity: 0.2, depthWrite: false
                });
            }
        }

        // --- 3D OBJECT LOGIC ---
        function spawnCore() {
            // NEW: Octahedron (Diamond Shape)
            const geo = new THREE.OctahedronGeometry(0.6, 0); 
            
            const mat = new THREE.MeshStandardMaterial({ color: 0xffffff }); 
            const mesh = new THREE.Mesh(geo, mat);
            mesh.castShadow = true;
            const wire = new THREE.LineSegments(
                new THREE.EdgesGeometry(geo),
                new THREE.LineBasicMaterial({ color: 0xff0055 })
            );
            mesh.add(wire);
            mesh.userData = { id: 7 };
            packetGroup.add(mesh);
            layerBoxes.push(mesh);
            rebuildSceneMaterials();
        }

        function addLayer(idx, instant=false) {
            // Just grab color from current lang data
            const layers = osiData[currentLang] || osiData['en'];
            const layer = layers.find(l => l.id === idx);
            if (!layer) return;

            const currentSize = 0.8 + (layerBoxes.length * 0.55);
            const geo = new THREE.BoxGeometry(currentSize, currentSize, currentSize);
            const mat = getThemeMaterial(layer.color);
            const box = new THREE.Mesh(geo, mat);
            box.castShadow = true;
            box.receiveShadow = true;

            const edges = new THREE.LineSegments(
                new THREE.EdgesGeometry(geo),
                new THREE.LineBasicMaterial({ color: layer.color, transparent: true })
            );
            box.add(edges);
            box.userData = { id: layer.id };
            packetGroup.add(box);
            layerBoxes.push(box);
            rebuildSceneMaterials();

            if(!instant) {
                box.scale.set(0.01, 0.01, 0.01);
                isAnimating = true;
                let p = 0;
                function grow() {
                    p += 0.05 * speedMult;
                    const s = Math.min(p, 1);
                    const scale = s === 1 ? 1 : 1 - Math.pow(2, -10 * s);
                    box.scale.setScalar(scale);
                    if(p < 1) requestAnimationFrame(grow);
                    else { isAnimating = false; updateExplode(); }
                }
                grow();
            }
        }

        function removeLayer() {
            const box = layerBoxes.pop();
            if(!box) return;
            isAnimating = true;
            let p = 0;
            function shrink() {
                p += 0.05 * speedMult;
                const s = 1 - p;
                box.scale.setScalar(Math.max(0.01, s));
                if(p < 1) requestAnimationFrame(shrink);
                else {
                    packetGroup.remove(box);
                    box.geometry.dispose();
                    isAnimating = false;
                    updateExplode();
                }
            }
            shrink();
        }

        // --- STAMP GENERATION ---
        function createStampTexture(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, 512, 512);
            
            // Style d'encre
            const inkColor = theme === 'cyberpunk' ? '#00f0ff' : '#d9002b'; // Cyan for Cyber, Red for others
            
            ctx.strokeStyle = inkColor;
            ctx.lineWidth = 15;
            
            // Outer Circle
            ctx.beginPath();
            ctx.arc(256, 256, 230, 0, Math.PI * 2);
            ctx.stroke();
            
            // Inner Box
            ctx.strokeRect(80, 200, 352, 112);

            // Text
            ctx.fillStyle = inkColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Main Text
            ctx.font = 'bold 60px "Black Ops One", "Courier New", monospace';
            ctx.fillText(text, 256, 256);
            
            // Top Text
            ctx.font = 'bold 40px "Courier New", monospace';
            ctx.fillText("PACKETLAB V1.2", 256, 140);
            
            // Date
            const date = new Date().toLocaleDateString();
            ctx.font = 'bold 30px "Courier New", monospace';
            ctx.fillText(date, 256, 380);

            const texture = new THREE.CanvasTexture(canvas);
            return texture;
        }

        function applyStampAnimation() {
            isAnimating = true;
            const t = translations[currentLang];
            
            // Determine stamp position (on the face of the outermost box)
            // Last box is packetGroup.children[packetGroup.children.length - 1];
            // Or layerBoxes[layerBoxes.length-1]
            const outerBox = layerBoxes[layerBoxes.length - 1];
            
            // Get size of outer box from geometry parameters
            // We know it's a BoxGeometry. parameters.width/height/depth
            const size = outerBox.geometry.parameters.width; 
            
            const stampTex = createStampTexture(t.stamp);
            const stampGeo = new THREE.PlaneGeometry(size * 0.6, size * 0.6);
            const stampMat = new THREE.MeshBasicMaterial({ 
                map: stampTex, 
                transparent: true, 
                opacity: 0, 
                side: THREE.DoubleSide, 
                depthTest: false // Always render on top if needed
            });
            
            stampMesh = new THREE.Mesh(stampGeo, stampMat);
            
            // Position slightly in front of the box face
            // Box center is 0,0,0. Face is at z = size/2.
            stampMesh.position.z = (size / 2) + 0.05;
            
            // Add to the group so it moves with the packet
            packetGroup.add(stampMesh);
            
            // Animation: Bam effect!
            let s = 2.0; // Start large
            stampMat.opacity = 0;
            
            function animateStamp() {
                s -= 0.1;
                stampMat.opacity += 0.15;
                stampMesh.scale.set(s, s, s);
                
                if (s > 1.0) {
                    requestAnimationFrame(animateStamp);
                } else {
                    stampMesh.scale.set(1, 1, 1);
                    stampMat.opacity = 0.9;
                    // Slight shake of the packet
                    setTimeout(() => {
                        sendAnimation();
                    }, 500);
                }
            }
            animateStamp();
        }

        // --- GAMEPLAY LOGIC ---
        function resetGame(newMode) {
            mode = newMode;
            isAnimating = false;
            if(autoplayTimer) toggleAutoplay();

            while(packetGroup.children.length > 0) packetGroup.remove(packetGroup.children[0]);
            layerBoxes = [];
            packetGroup.position.set(0,0,0);
            packetGroup.rotation.set(0,0,0);
            packetGroup.scale.set(1,1,1);
            packetGroup.visible = true;
            
            stampMesh = null; // Reset stamp reference

            const t = translations[currentLang];
            ui.modeLabel.innerText = mode === 'encap' ? t.modeEncap : t.modeDecap;
            
            ui.msg.style.opacity = 0;
            ui.btnDecap.style.display = 'none';
            ui.btnReset.style.display = 'none';
            ui.btnMain.style.display = 'block';
            ui.btnMain.disabled = false;

            // Mobile controls reset
            if (document.getElementById('mb-standard-controls')) {
                document.getElementById('mb-standard-controls').style.display = 'flex';
                document.getElementById('mb-reset').style.display = 'none';
            }

            if(mode === 'encap') {
                currentStep = 0;
                spawnCore();
            } else {
                currentStep = 6;
                spawnCore();
                for(let i=6; i>=1; i--) {
                    addLayer(i, true);
                }
            }
            updateUI();
        }

        function nextStep() {
            if(isAnimating) return;
            const layers = osiData[currentLang] || osiData['en'];

            if(mode === 'encap') {
                if(currentStep < 6) {
                    currentStep++; 
                    addLayer(7 - currentStep);
                    updateUI();
                } else {
                    // Trigger Stamp before Send
                    applyStampAnimation();
                }
            } else {
                if(currentStep > 0) {
                    removeLayer();
                    currentStep--;
                    updateUI();
                } else {
                    finishDecap();
                }
            }
        }

        function prevStep() {
            if(isAnimating) return;
            if(mode === 'encap') {
                if(currentStep > 0) {
                    removeLayer();
                    currentStep--;
                    updateUI();
                }
            } else {
                if(currentStep < 6) {
                    currentStep++;
                    addLayer(7 - currentStep);
                    updateUI();
                }
            }
        }

        function sendAnimation() {
            isAnimating = true;
            const t = translations[currentLang];
            ui.msg.innerText = t.msgSending;
            ui.msg.style.opacity = 1;
            let speed = 0;
            function fly() {
                speed += 0.5 * speedMult;
                packetGroup.position.z -= speed;
                packetGroup.rotation.z += 0.1;
                if(theme === 'mirror') packetGroup.scale.z += 0.1;

                if(packetGroup.position.z > -100) {
                    requestAnimationFrame(fly);
                } else {
                    ui.msg.innerText = t.msgSent;
                    packetGroup.visible = false;
                    ui.btnMain.style.display = 'none';
                    ui.btnDecap.style.display = 'block';
                    ui.btnReset.style.display = 'block';

                    // Mobile switch to reset button
                    if (document.getElementById('mb-standard-controls')) {
                        document.getElementById('mb-standard-controls').style.display = 'none';
                        document.getElementById('mb-reset').style.display = 'block';
                    }

                    if(autoplayTimer) toggleAutoplay();
                }
            }
            fly();
        }

        function finishDecap() {
            const t = translations[currentLang];
            ui.msg.innerText = t.msgReceived;
            ui.msg.style.opacity = 1;
            ui.btnMain.disabled = true;
            ui.btnReset.style.display = 'block';

             // Mobile switch to reset button
             if (document.getElementById('mb-standard-controls')) {
                document.getElementById('mb-standard-controls').style.display = 'none';
                document.getElementById('mb-reset').style.display = 'block';
            }

            if(autoplayTimer) toggleAutoplay();
        }

        function updateUI() {
            const t = translations[currentLang];
            const layers = osiData[currentLang] || osiData['en'];
            
            // currentStep 0 -> Layer 7 (Index 0)
            const layer = layers[currentStep];
            const nextLayer = layers[currentStep + 1]; 
            
            let displayColor = layer.color;
            if(theme === 'mirror' && layer.id === 1) displayColor = "#334155";

            const layerName = layer.name.toUpperCase();
            const layerLabel = t.layer || "LAYER";

            ui.layerTitle.innerText = `${layerLabel} ${layer.id}: ${layerName}`;
            ui.layerTitle.style.color = displayColor;
            ui.step.innerText = (mode === 'encap' ? (currentStep + 1) : (7 - currentStep)) + " / 7";
            ui.pdu.innerText = layer.pdu;
            ui.pdu.style.color = displayColor;
            ui.header.innerText = layer.header;
            ui.desc.innerText = layer.desc;
            ui.details.innerHTML = layer.details.map(d => `> ${d}`).join('<br>');
            ui.ex.innerHTML = `"${layer.ex}"`;

            if(mode === 'encap') {
                if(currentStep < 6) ui.btnMain.innerText = `${t.btnAdd} ${nextLayer.name.toUpperCase()}`;
                else ui.btnMain.innerText = t.btnTransmit;
            } else {
                if(currentStep > 0) ui.btnMain.innerText = `${t.btnRemove} ${layer.name.toUpperCase()}`;
                else ui.btnMain.innerText = t.btnAccess;
            }

            ui.list.innerHTML = '';
            layers.forEach((l, idx) => {
                const li = document.createElement('li');
                li.className = 'layer-item';
                
                let itemColor = l.color;
                if(theme === 'mirror' && l.id === 1) itemColor = "#334155";
                li.style.color = itemColor; 
                
                li.innerHTML = `<span style="font-weight:900;">0${l.id}</span> ${l.name.toUpperCase()}`;
                
                if(l.id === layer.id) li.classList.add('active');
                
                let existsInStack = false;
                if (mode === 'encap') existsInStack = (idx <= currentStep);
                else existsInStack = (idx >= currentStep); 

                if(existsInStack) li.style.opacity = 1; else li.style.opacity = 0.3;
                
                ui.list.appendChild(li);
            });

            const pct = mode === 'encap' ? ((currentStep/6)*100) : ((6-currentStep)/6)*100;
            ui.bar.style.width = `${pct}%`;
            ui.bar.style.backgroundColor = displayColor;

            updateExplode();
        }

        function updateExplode() {
            if(!isExploded) {
                layerBoxes.forEach(b => b.position.set(0,0,0));
                return;
            }
            layerBoxes.forEach((b, i) => { b.position.y = (i * 0.6); });
        }

        function toggleExplode() {
            isExploded = !isExploded;
            const t = translations[currentLang];
            document.getElementById('explode-btn').innerText = isExploded ? t.btnExplodeOn : t.btnExplodeOff;
            updateExplode();
        }

        function toggleAutoplay() {
            const btn = document.getElementById('autoplay-btn');
            const t = translations[currentLang];
            if(autoplayTimer) {
                clearInterval(autoplayTimer);
                autoplayTimer = null;
                btn.innerText = t.btnAuto;
                btn.classList.remove('border-green-500');
                // Also update mobile button
                if (ui.mbAuto) ui.mbAuto.innerText = t.btnAuto;
            } else {
                btn.innerText = t.btnStop;
                btn.classList.add('border-green-500');
                // Also update mobile button
                if (ui.mbAuto) ui.mbAuto.innerText = t.btnStop;
                autoplayTimer = setInterval(() => {
                    if(!isAnimating) nextStep();
                }, 2000 / speedMult);
            }
        }

        function toggleSpeed() {
            speedMult = speedMult === 1 ? 2 : (speedMult === 2 ? 0.5 : 1);
            document.getElementById('speed-btn').innerText = `x${speedMult}`;
            if(autoplayTimer) { toggleAutoplay(); toggleAutoplay(); }
        }

        function createParticles() {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(2000 * 3);
            for(let i=0; i<6000; i++) pos[i] = (Math.random()-0.5)*40;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ size: 0.1, color: 0x00aaff, transparent: true, opacity: 0.4, blending: THREE.AdditiveBlending });
            particles = new THREE.Points(geo, mat);
            scene.add(particles);
        }

        // --- MATRIX RAIN IMPLEMENTATION ---
        function initMatrixRain() {
            const canvas = document.getElementById('matrix-bg');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            
            const setSize = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };
            setSize();
            window.addEventListener('resize', setSize);
            
            // Katakana + Latin
            const chars = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const charArray = chars.split('');
            
            const fontSize = 16;
            let columns = canvas.width / fontSize;
            let drops = [];
            
            const resetDrops = () => {
                columns = canvas.width / fontSize;
                drops = [];
                for(let x=0; x<columns; x++) drops[x] = 1;
            };
            resetDrops();
            window.addEventListener('resize', resetDrops);

            function drawMatrix() {
                // Optimization: Only draw if visible
                if(theme !== 'matrix') {
                    // ctx.clearRect(0,0,canvas.width, canvas.height);
                    // Don't clear, just stop drawing
                    return;
                }
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#0F0';
                ctx.font = fontSize + 'px monospace';
                
                for(let i=0; i<drops.length; i++) {
                    const text = charArray[Math.floor(Math.random() * charArray.length)];
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    
                    if(drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
                
                // Update 3D texture
                if(matrixTexture) matrixTexture.needsUpdate = true;
            }
            setInterval(drawMatrix, 33);
        }

        function onResize() {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
            const matCanvas = document.getElementById('matrix-bg');
            if(matCanvas) {
                matCanvas.width = window.innerWidth;
                matCanvas.height = window.innerHeight;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            const time = Date.now() * 0.001;
            
            if(!isAnimating && packetGroup.visible) {
                if(!isExploded) {
                    packetGroup.position.y = Math.sin(time * 0.5) * 0.2;
                    if(theme === 'mirror') {
                         if(layerBoxes.length > 0) {
                            layerBoxes.forEach((b, i) => {
                                 b.rotation.z = Math.sin(time * 0.5 + i) * 0.02;
                            });
                        }
                    } else {
                        packetGroup.rotation.y = Math.sin(time * 0.1) * 0.1;
                    }
                } else {
                    packetGroup.position.y = 0;
                }
            }
            // CRITICAL FIX for Matrix Rain Visibility
            if (theme === 'matrix') {
                renderer.render(scene, camera); // Bypass composer to keep transparency
            } else {
                composer.render(); // Use bloom for other modes
            }
        }

        init();
    });
  </script>
</body>
</html>
